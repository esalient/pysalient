API Reference
=============

This section provides detailed API references for the pysSALIENT framework modules.

IO Module
---------

.. automodule:: pysalient.io
   :members:

Functions for exporting results:

.. autofunction:: pysalient.io.export_evaluation_results

.. autofunction:: pysalient.io.export_formatted_results

Evaluation Module
-----------------

.. automodule:: pysalient.evaluation
   :members:

Time-to-Event Metrics
^^^^^^^^^^^^^^^^^^^^^

The evaluation module now supports calculating time-to-event metrics for clinical events. 
These metrics calculate the time from model alerts to clinical events for true positives only, 
aggregated at the encounter level.

Key parameters for time-to-event functionality:

- ``time_to_event_cols``: Dictionary mapping metric names to clinical event column names
- ``aggregation_func``: Aggregation function for encounter-level aggregation (default: "median")

For detailed parameter documentation and examples, see the :func:`pysalient.evaluation.evaluation` function docstring.

Performance and Safety Controls
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The evaluation function includes safety controls to prevent accidental execution of computationally expensive evaluations:

- **Threshold Limit**: By default, evaluation is limited to 10 thresholds to prevent excessive computation
- **Override Control**: Use ``force_eval=True`` to bypass the limit when needed for comprehensive analysis

.. warning::
   Evaluating many thresholds (>10) can be computationally expensive, especially with confidence interval calculations enabled. Use ``force_eval=True`` carefully and consider the computational cost.

Example with many thresholds:

.. code-block:: python

   # This will raise an error by default
   try:
       results = eval.evaluation(data, "model", "filter", 
                               thresholds=np.linspace(0, 1, 50))  # 50 thresholds
   except ValueError as e:
       print(f"Error: {e}")
   
   # Override the safety check
   results = eval.evaluation(data, "model", "filter", 
                           thresholds=np.linspace(0, 1, 50),
                           force_eval=True)  # Allows 50 thresholds


Visualisation and Display Helpers
---------------------------------

This module provides helper functions for visualizing and displaying results generated by other pysalient modules, particularly the evaluation results table.

.. automodule:: pysalient.visualisation
   :members:
   :undoc-members:
   :show-inheritance:

Usage Example
^^^^^^^^^^^^^

The primary function currently is `format_evaluation_table`, which helps display the float values in the evaluation results table with consistent formatting in environments like Jupyter notebooks.

.. code-block:: python

   import pysalient.evaluation as eval
   import pysalient.visualisation as vis
   import pysalient.io as io # Assuming io is used to load data

   # --- Load your data ---
   # Example using sample data and assigned names
   sample_data_path = 'data/anonymised_sample.parquet' # Adjust path as needed
   col_map = {
       'y_proba': 'prediction_probability',
       'y_label': 'true_label',
       'agg': 'encounter_id',
       'time': 'event_timestamp',
   }
   assigned_table = io.load_evaluation_data(
       source=sample_data_path,
       y_proba_col=col_map['y_proba'],
       y_label_col=col_map['y_label'],
       aggregation_cols=col_map['agg'],
       assign_task_name="AKI",
       assign_model_name="LogRegress",
       perform_aggregation=True,  # Enable aggregation by encounter
       label_agg_func="max"  # Use max aggregation for labels (any positive makes group positive)
   )

   # --- Run evaluation ---
   # The 'evaluation' function will use the time-to-event parameters.
   results_table = eval.evaluation(
       data=assigned_table,
       modelid="BaselineLogisticRegression",
       filter_desc="placeholder_filter",
       thresholds=(0.1, 0.9, 0.1),  # This generates 9 thresholds, within the default limit
       time_to_event_cols={
           'culture': 'blood_culture_timestamp',
           'antibiotics': 'antibiotic_timestamp'
       }, # Optional: clinical event columns for time-to-event metrics
       aggregation_func="median", # Aggregation function for time-to-event (default: median)
       time_unit="hours", # Unit label for time-to-event column names (default: hours)
       decimal_places=3, # Evaluation rounding (optional)
       # force_eval=True  # Uncomment if using >10 thresholds
   )

   # The 'results_table' will now contain dynamic columns for time-to-event metrics:
   # - 'median_hours_from_first_alert_to_culture' (or other aggregation function and time unit)
   # - 'count_first_alerts_before_culture' 
   # - 'count_first_alerts_after_or_at_culture'
   # - Similar columns for 'antibiotics'

   # --- Format for display ---
   # Use the helper to format float columns (e.g., to 3 decimal places)
   styled_table = vis.format_evaluation_table(results_table, decimal_places=3)

   # Display in Jupyter/IPython
   # display(styled_table) # Uncomment in a notebook environment

   # If not in Jupyter, you might render to HTML
   # html_output = styled_table.render()
   # print(html_output)
