name: Publish to PyPI and Build Conda Package

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (skip actual publishing)'
        required: false
        default: 'false'

jobs:
  publish-pypi:
    name: Build and Publish to PyPI
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for trusted publishing to PyPI
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.40.2
          cache: true

      - name: Extract version from tag
        if: github.event_name == 'push'
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Verify version matches pyproject.toml
        if: github.event_name == 'push'
        run: |
          PYPROJECT_VERSION=$(pixi run python -c "import tomli; print(tomli.load(open('pyproject.toml', 'rb'))['project']['version'])" 2>/dev/null || \
                              pixi run python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
          echo "Tag version: $VERSION"
          echo "pyproject.toml version: $PYPROJECT_VERSION"
          if [ "$VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "Error: Version mismatch between tag ($VERSION) and pyproject.toml ($PYPROJECT_VERSION)"
            exit 1
          fi

      - name: Run tests
        run: pixi run test

      - name: Build package with pixi
        run: |
          # Install build dependencies
          pixi run python -m pip install --upgrade build twine

          # Build the package
          pixi run python -m build

          # List the built packages
          ls -lh dist/

      - name: Check package with twine
        run: pixi run twine check dist/*

      - name: Publish to Test PyPI (dry-run or manual trigger)
        if: github.event.inputs.dry_run == 'true' || github.event_name == 'workflow_dispatch'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          echo "Publishing to Test PyPI..."
          pixi run twine upload --repository testpypi dist/* --verbose || true

      - name: Publish to PyPI (on tag push)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true
          verbose: true

  build-conda:
    name: Build Conda Package with Pixi
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.40.2
          cache: true

      - name: Install pixi-build
        run: pixi global install pixi-build

      - name: Build conda package with pixi-build
        run: |
          echo "Building conda package..."
          pixi build

      - name: List built packages
        shell: bash
        run: |
          echo "Built packages:"
          find . -name "*.tar.bz2" -o -name "*.conda" || echo "No conda packages found"

      - name: Upload conda package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: conda-package-${{ matrix.os }}
          path: |
            output/**/*.tar.bz2
            output/**/*.conda
          if-no-files-found: warn

  create-release:
    name: Create GitHub Release
    needs: [publish-pypi, build-conda]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/*.tar.bz2
            artifacts/**/*.conda
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
